//@version=6
library("BucketingLib", true)
import "../libraries/price_precision_lib.pine" as pp
import "../libraries/map_utils_lib.pine" as map

//@description Groups nearby levels into price buckets
//@param levels  array<float>
//@param proximity  simple float (bucket width)
//@returns          map<float,int>
export bucketMap(array<float> levels, simple float proximity) =>
    // Create a new map on each invocation to avoid residual values
    map<float,int> buckets = map.new<float,int>()
    if proximity > 0
        for lvl in levels
            if not na(lvl)
                map.put(buckets, b, map.get_if_contains(buckets, b, 0) + 1)
                buckets.put(b, (buckets.contains(b) ? buckets.get(b) : 0) + 1)
    buckets
